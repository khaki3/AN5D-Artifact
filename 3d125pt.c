#define BENCH_DIM 3
#define BENCH_FPP 130
#define BENCH_RAD 2

#include "common.h"

double kernel_stencil(SB_TYPE *A1, int compsize, int timestep, bool scop)
{
  double start_time = sb_time(), end_time = 0.0;
  int dimsize = compsize + BENCH_RAD * 2;
  SB_TYPE (*A)[dimsize][dimsize][dimsize]
    = (SB_TYPE (*)[dimsize][dimsize][dimsize])A1;

  if (scop) {
#pragma scop
    for (int t = 0; t < timestep; t++)
      for (int k = BENCH_RAD; k < dimsize - BENCH_RAD; k++)
        for (int j = BENCH_RAD; j < dimsize - BENCH_RAD; j++)
          for (int i = BENCH_RAD; i < dimsize - BENCH_RAD; i++)
            A[(t+1)%2][k][j][i] =
              0.75 * (A[t%2][k-2][j-2][i-2] + A[t%2][k-2][j-2][i+2] + A[t%2][k-2][j+2][i-2] + A[t%2][k-2][j+2][i+2] + A[t%2][k-1][j-1][i-1] + A[t%2][k-1][j-1][i+1] + A[t%2][k-1][j+1][i-1] + A[t%2][k-1][j+1][i+1] +
                      A[t%2][k][j-1][i] + A[t%2][k][j][i-1] +  A[t%2][k][j][i+1] + A[t%2][k][j+1][i] +
                      A[t%2][k+1][j-1][i-1] + A[t%2][k+1][j-1][i+1] + A[t%2][k+1][j+1][i-1] + A[t%2][k+1][j+1][i+1]) +
              0.76 * (A[t%2][k-2][j-2][i-2] + A[t%2][k-2][j-2][i+2] + A[t%2][k-2][j+2][i-2] + A[t%2][k-2][j+2][i+2]) +

              1.132 * (A[t%2][k-2][j-2][i-1] + A[t%2][k-2][j-2][i+1] + A[t%2][k-2][j-1][i-2] + A[t%2][k-2][j-1][i+2] + A[t%2][k-2][j][i] + A[t%2][k-2][j+1][i-2] + A[t%2][k-2][j+1][i+2] + A[t%2][k-2][j+2][i-1] +  A[t%2][k-2][j+2][i+1] +
                       A[t%2][k-1][j-2][i-2] + A[t%2][k-1][j-2][i+2] + A[t%2][k-1][j+2][i-2] + A[t%2][k-1][j+2][i+2] +
                       A[t%2][k][j-2][i] + A[t%2][k][j][i-2] + A[t%2][k][j][i+2] + A[t%2][k][j+2][i] +
                       A[t%2][k+1][j-2][i-2] + A[t%2][k+1][j-2][i+2] + A[t%2][k+1][j+2][i-2] + A[t%2][k+1][j+2][i+2] +
                       A[t%2][k-2][j-2][i-1] + A[t%2][k-2][j-2][i+1] + A[t%2][k-2][j-1][i-2] + A[t%2][k-2][j-1][i+2] + A[t%2][k-2][j][i] + A[t%2][k-2][j+1][i-2] + A[t%2][k-2][j+1][i+2] + A[t%2][k-2][j+2][i-1] +  A[t%2][k-2][j+2][i+1]) +

              0.217 * (A[t%2][k-2][j-2][i] + A[t%2][k-2][j][i-2] + A[t%2][k-2][j][i+2] + A[t%2][k-2][j+2][i] +
                       A[t%2][k-1][j-1][i] + A[t%2][k-1][j][i-1] +  A[t%2][k-1][j][i+1] + A[t%2][k-1][j+1][i] +
                       A[t%2][k][j-2][i-2] + A[t%2][k][j-2][i+2] + A[t%2][k][j+2][i-2] + A[t%2][k][j+2][i+2] +
                       A[t%2][k+1][j-1][i] + A[t%2][k+1][j][i-1] +  A[t%2][k+1][j][i+1] + A[t%2][k+1][j+1][i] +
                       A[t%2][k-2][j-2][i] + A[t%2][k-2][j][i-2] + A[t%2][k-2][j][i+2] + A[t%2][k-2][j+2][i]) +

              2.13 * (A[t%2][k-2][j-1][i] + A[t%2][k-2][j][i-1] +  A[t%2][k-2][j][i+1] + A[t%2][k-2][j+1][i] +
                      A[t%2][k-1][j-2][i] + A[t%2][k-1][j][i-2] + A[t%2][k-1][j][i+2] + A[t%2][k-1][j+2][i] +
                      A[t%2][k][j-2][i-1] + A[t%2][k][j-2][i+1] + A[t%2][k][j-1][i-2] + A[t%2][k][j-1][i+2] + A[t%2][k][j][i] + A[t%2][k][j+1][i-2] + A[t%2][k][j+1][i+2] + A[t%2][k][j+2][i-1] +  A[t%2][k][j+2][i+1] +
                      A[t%2][k+1][j-2][i] + A[t%2][k+1][j][i-2] + A[t%2][k+1][j][i+2] + A[t%2][k+1][j+2][i] +
                      A[t%2][k-2][j-1][i] + A[t%2][k-2][j][i-1] +  A[t%2][k-2][j][i+1] + A[t%2][k-2][j+1][i]) +

              0.331 * (A[t%2][k-2][j-1][i-1] + A[t%2][k-2][j-1][i+1] + A[t%2][k-2][j+1][i-1] + A[t%2][k-2][j+1][i+1] +
                       A[t%2][k-1][j-2][i-1] + A[t%2][k-1][j-2][i+1] + A[t%2][k-1][j-1][i-2] + A[t%2][k-1][j-1][i+2] + A[t%2][k-1][j][i] + A[t%2][k-1][j+1][i-2] + A[t%2][k-1][j+1][i+2] + A[t%2][k-1][j+2][i-1] +  A[t%2][k-1][j+2][i+1] +
                       A[t%2][k][j-1][i-1] + A[t%2][k][j-1][i+1] + A[t%2][k][j+1][i-1] + A[t%2][k][j+1][i+1] +
                       A[t%2][k+1][j-2][i-1] + A[t%2][k+1][j-2][i+1] + A[t%2][k+1][j-1][i-2] + A[t%2][k+1][j-1][i+2] + A[t%2][k+1][j][i] + A[t%2][k+1][j+1][i-2] + A[t%2][k+1][j+1][i+2] + A[t%2][k+1][j+2][i-1] +  A[t%2][k+1][j+2][i+1]) +
              0.332 * (A[t%2][k-2][j-1][i-1] + A[t%2][k-2][j-1][i+1] + A[t%2][k-2][j+1][i-1] + A[t%2][k-2][j+1][i+1]);
#pragma endscop
  }
  else {
    for (int t = 0; t < timestep; t++)
#pragma omp parallel for
      for (int k = BENCH_RAD; k < dimsize - BENCH_RAD; k++)
        for (int j = BENCH_RAD; j < dimsize - BENCH_RAD; j++)
          for (int i = BENCH_RAD; i < dimsize - BENCH_RAD; i++)
            A[(t+1)%2][k][j][i] =
              0.75 * (A[t%2][k-2][j-2][i-2] + A[t%2][k-2][j-2][i+2] + A[t%2][k-2][j+2][i-2] + A[t%2][k-2][j+2][i+2] + A[t%2][k-1][j-1][i-1] + A[t%2][k-1][j-1][i+1] + A[t%2][k-1][j+1][i-1] + A[t%2][k-1][j+1][i+1] +
                      A[t%2][k][j-1][i] + A[t%2][k][j][i-1] +  A[t%2][k][j][i+1] + A[t%2][k][j+1][i] +
                      A[t%2][k+1][j-1][i-1] + A[t%2][k+1][j-1][i+1] + A[t%2][k+1][j+1][i-1] + A[t%2][k+1][j+1][i+1]) +
              0.76 * (A[t%2][k-2][j-2][i-2] + A[t%2][k-2][j-2][i+2] + A[t%2][k-2][j+2][i-2] + A[t%2][k-2][j+2][i+2]) +

              1.132 * (A[t%2][k-2][j-2][i-1] + A[t%2][k-2][j-2][i+1] + A[t%2][k-2][j-1][i-2] + A[t%2][k-2][j-1][i+2] + A[t%2][k-2][j][i] + A[t%2][k-2][j+1][i-2] + A[t%2][k-2][j+1][i+2] + A[t%2][k-2][j+2][i-1] +  A[t%2][k-2][j+2][i+1] +
                       A[t%2][k-1][j-2][i-2] + A[t%2][k-1][j-2][i+2] + A[t%2][k-1][j+2][i-2] + A[t%2][k-1][j+2][i+2] +
                       A[t%2][k][j-2][i] + A[t%2][k][j][i-2] + A[t%2][k][j][i+2] + A[t%2][k][j+2][i] +
                       A[t%2][k+1][j-2][i-2] + A[t%2][k+1][j-2][i+2] + A[t%2][k+1][j+2][i-2] + A[t%2][k+1][j+2][i+2] +
                       A[t%2][k-2][j-2][i-1] + A[t%2][k-2][j-2][i+1] + A[t%2][k-2][j-1][i-2] + A[t%2][k-2][j-1][i+2] + A[t%2][k-2][j][i] + A[t%2][k-2][j+1][i-2] + A[t%2][k-2][j+1][i+2] + A[t%2][k-2][j+2][i-1] +  A[t%2][k-2][j+2][i+1]) +

              0.217 * (A[t%2][k-2][j-2][i] + A[t%2][k-2][j][i-2] + A[t%2][k-2][j][i+2] + A[t%2][k-2][j+2][i] +
                       A[t%2][k-1][j-1][i] + A[t%2][k-1][j][i-1] +  A[t%2][k-1][j][i+1] + A[t%2][k-1][j+1][i] +
                       A[t%2][k][j-2][i-2] + A[t%2][k][j-2][i+2] + A[t%2][k][j+2][i-2] + A[t%2][k][j+2][i+2] +
                       A[t%2][k+1][j-1][i] + A[t%2][k+1][j][i-1] +  A[t%2][k+1][j][i+1] + A[t%2][k+1][j+1][i] +
                       A[t%2][k-2][j-2][i] + A[t%2][k-2][j][i-2] + A[t%2][k-2][j][i+2] + A[t%2][k-2][j+2][i]) +

              2.13 * (A[t%2][k-2][j-1][i] + A[t%2][k-2][j][i-1] +  A[t%2][k-2][j][i+1] + A[t%2][k-2][j+1][i] +
                      A[t%2][k-1][j-2][i] + A[t%2][k-1][j][i-2] + A[t%2][k-1][j][i+2] + A[t%2][k-1][j+2][i] +
                      A[t%2][k][j-2][i-1] + A[t%2][k][j-2][i+1] + A[t%2][k][j-1][i-2] + A[t%2][k][j-1][i+2] + A[t%2][k][j][i] + A[t%2][k][j+1][i-2] + A[t%2][k][j+1][i+2] + A[t%2][k][j+2][i-1] +  A[t%2][k][j+2][i+1] +
                      A[t%2][k+1][j-2][i] + A[t%2][k+1][j][i-2] + A[t%2][k+1][j][i+2] + A[t%2][k+1][j+2][i] +
                      A[t%2][k-2][j-1][i] + A[t%2][k-2][j][i-1] +  A[t%2][k-2][j][i+1] + A[t%2][k-2][j+1][i]) +

              0.331 * (A[t%2][k-2][j-1][i-1] + A[t%2][k-2][j-1][i+1] + A[t%2][k-2][j+1][i-1] + A[t%2][k-2][j+1][i+1] +
                       A[t%2][k-1][j-2][i-1] + A[t%2][k-1][j-2][i+1] + A[t%2][k-1][j-1][i-2] + A[t%2][k-1][j-1][i+2] + A[t%2][k-1][j][i] + A[t%2][k-1][j+1][i-2] + A[t%2][k-1][j+1][i+2] + A[t%2][k-1][j+2][i-1] +  A[t%2][k-1][j+2][i+1] +
                       A[t%2][k][j-1][i-1] + A[t%2][k][j-1][i+1] + A[t%2][k][j+1][i-1] + A[t%2][k][j+1][i+1] +
                       A[t%2][k+1][j-2][i-1] + A[t%2][k+1][j-2][i+1] + A[t%2][k+1][j-1][i-2] + A[t%2][k+1][j-1][i+2] + A[t%2][k+1][j][i] + A[t%2][k+1][j+1][i-2] + A[t%2][k+1][j+1][i+2] + A[t%2][k+1][j+2][i-1] +  A[t%2][k+1][j+2][i+1]) +
              0.332 * (A[t%2][k-2][j-1][i-1] + A[t%2][k-2][j-1][i+1] + A[t%2][k-2][j+1][i-1] + A[t%2][k-2][j+1][i+1]);
  }

  return (((end_time != 0.0) ? end_time : sb_time()) - start_time);
}
